name: Continuous Integration

on:
  pull_request:
    branches: ["main"]

jobs:
  frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: |
          cd frontend 
          npm ci

    #   - name: Run linting
    #     run: |
    #       cd frontend
    #       npm run lint

      # - name : Run Tests Suite
      #   run : cd frontend && npm test

      - name: Build Application
        run: |
          cd frontend
          npm run build

  backend:
    runs-on: ubuntu-latest

    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Nodejs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        run: |
          cd backend
          npm ci

      # - name : Run Tests Suite
      #   run : cd backend && npm test

      - name: Start Server
        env:
          PORT: ${{ secrets.PORT }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          cd backend
          npm start &
          sleep 10

      - name: Health Check
        run: |
          curl --fail http://localhost:${{ secrets.PORT }}/api/health
